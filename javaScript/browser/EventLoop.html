<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Event Loop | fe-tutorial</title>
    <meta name="description" content="前端学习笔记">
    <link rel="icon" href="/fe-tutorial/favicon.ico">
    
    <link rel="preload" href="/fe-tutorial/assets/css/0.styles.d95e4697.css" as="style"><link rel="preload" href="/fe-tutorial/assets/js/app.543b8577.js" as="script"><link rel="preload" href="/fe-tutorial/assets/js/2.9b3345fe.js" as="script"><link rel="preload" href="/fe-tutorial/assets/js/17.36973dd6.js" as="script"><link rel="prefetch" href="/fe-tutorial/assets/js/10.723f5f67.js"><link rel="prefetch" href="/fe-tutorial/assets/js/11.49fa0c43.js"><link rel="prefetch" href="/fe-tutorial/assets/js/12.fd432713.js"><link rel="prefetch" href="/fe-tutorial/assets/js/13.d0e78940.js"><link rel="prefetch" href="/fe-tutorial/assets/js/14.525140fb.js"><link rel="prefetch" href="/fe-tutorial/assets/js/15.70eca4b3.js"><link rel="prefetch" href="/fe-tutorial/assets/js/16.42489512.js"><link rel="prefetch" href="/fe-tutorial/assets/js/18.b5200278.js"><link rel="prefetch" href="/fe-tutorial/assets/js/19.cbbeaa24.js"><link rel="prefetch" href="/fe-tutorial/assets/js/20.e6890c41.js"><link rel="prefetch" href="/fe-tutorial/assets/js/21.5b822627.js"><link rel="prefetch" href="/fe-tutorial/assets/js/22.f96b97dd.js"><link rel="prefetch" href="/fe-tutorial/assets/js/23.bd0c9df4.js"><link rel="prefetch" href="/fe-tutorial/assets/js/24.dced6486.js"><link rel="prefetch" href="/fe-tutorial/assets/js/25.0d195834.js"><link rel="prefetch" href="/fe-tutorial/assets/js/26.d4ebda1a.js"><link rel="prefetch" href="/fe-tutorial/assets/js/27.e55fcfd2.js"><link rel="prefetch" href="/fe-tutorial/assets/js/28.6c7589bb.js"><link rel="prefetch" href="/fe-tutorial/assets/js/29.ab5e9c20.js"><link rel="prefetch" href="/fe-tutorial/assets/js/3.f5841e8a.js"><link rel="prefetch" href="/fe-tutorial/assets/js/30.171f4d28.js"><link rel="prefetch" href="/fe-tutorial/assets/js/31.01417dc4.js"><link rel="prefetch" href="/fe-tutorial/assets/js/32.0efbfbb9.js"><link rel="prefetch" href="/fe-tutorial/assets/js/33.9634aee8.js"><link rel="prefetch" href="/fe-tutorial/assets/js/34.0b8763f8.js"><link rel="prefetch" href="/fe-tutorial/assets/js/35.97be856a.js"><link rel="prefetch" href="/fe-tutorial/assets/js/36.b241809e.js"><link rel="prefetch" href="/fe-tutorial/assets/js/37.f2c2632e.js"><link rel="prefetch" href="/fe-tutorial/assets/js/38.e174c07f.js"><link rel="prefetch" href="/fe-tutorial/assets/js/39.bdc0f4cd.js"><link rel="prefetch" href="/fe-tutorial/assets/js/4.ef22da56.js"><link rel="prefetch" href="/fe-tutorial/assets/js/40.053626ac.js"><link rel="prefetch" href="/fe-tutorial/assets/js/41.ec129698.js"><link rel="prefetch" href="/fe-tutorial/assets/js/42.4c4cb10a.js"><link rel="prefetch" href="/fe-tutorial/assets/js/43.4b624a09.js"><link rel="prefetch" href="/fe-tutorial/assets/js/44.4aa8411b.js"><link rel="prefetch" href="/fe-tutorial/assets/js/45.37beebd2.js"><link rel="prefetch" href="/fe-tutorial/assets/js/46.640027b0.js"><link rel="prefetch" href="/fe-tutorial/assets/js/47.75b6dbd2.js"><link rel="prefetch" href="/fe-tutorial/assets/js/48.03311ce2.js"><link rel="prefetch" href="/fe-tutorial/assets/js/49.420e3429.js"><link rel="prefetch" href="/fe-tutorial/assets/js/5.c717640f.js"><link rel="prefetch" href="/fe-tutorial/assets/js/50.ef86af47.js"><link rel="prefetch" href="/fe-tutorial/assets/js/51.49949bab.js"><link rel="prefetch" href="/fe-tutorial/assets/js/52.99453c8f.js"><link rel="prefetch" href="/fe-tutorial/assets/js/53.2a67d7c1.js"><link rel="prefetch" href="/fe-tutorial/assets/js/54.0a409de1.js"><link rel="prefetch" href="/fe-tutorial/assets/js/55.33c2223b.js"><link rel="prefetch" href="/fe-tutorial/assets/js/56.0dd27231.js"><link rel="prefetch" href="/fe-tutorial/assets/js/57.0197d5e1.js"><link rel="prefetch" href="/fe-tutorial/assets/js/58.9d671ec7.js"><link rel="prefetch" href="/fe-tutorial/assets/js/59.b55734ab.js"><link rel="prefetch" href="/fe-tutorial/assets/js/6.6ec1b109.js"><link rel="prefetch" href="/fe-tutorial/assets/js/60.4ee6cb7e.js"><link rel="prefetch" href="/fe-tutorial/assets/js/61.3ad47b95.js"><link rel="prefetch" href="/fe-tutorial/assets/js/62.4d094156.js"><link rel="prefetch" href="/fe-tutorial/assets/js/63.6ddebfde.js"><link rel="prefetch" href="/fe-tutorial/assets/js/64.3dd969b8.js"><link rel="prefetch" href="/fe-tutorial/assets/js/65.696a93f5.js"><link rel="prefetch" href="/fe-tutorial/assets/js/66.6c1dbc73.js"><link rel="prefetch" href="/fe-tutorial/assets/js/67.df7fa7e3.js"><link rel="prefetch" href="/fe-tutorial/assets/js/68.97ff5a3c.js"><link rel="prefetch" href="/fe-tutorial/assets/js/69.770a9bec.js"><link rel="prefetch" href="/fe-tutorial/assets/js/7.eab21b1c.js"><link rel="prefetch" href="/fe-tutorial/assets/js/70.556f2b61.js"><link rel="prefetch" href="/fe-tutorial/assets/js/71.b5b7490d.js"><link rel="prefetch" href="/fe-tutorial/assets/js/72.3ec804ad.js"><link rel="prefetch" href="/fe-tutorial/assets/js/73.83dbd5c5.js"><link rel="prefetch" href="/fe-tutorial/assets/js/74.82cc556b.js"><link rel="prefetch" href="/fe-tutorial/assets/js/75.c37d9196.js"><link rel="prefetch" href="/fe-tutorial/assets/js/76.1a7823bb.js"><link rel="prefetch" href="/fe-tutorial/assets/js/77.113bd0d7.js"><link rel="prefetch" href="/fe-tutorial/assets/js/78.400bdaae.js"><link rel="prefetch" href="/fe-tutorial/assets/js/79.459a01d7.js"><link rel="prefetch" href="/fe-tutorial/assets/js/8.7e8fd415.js"><link rel="prefetch" href="/fe-tutorial/assets/js/80.667891a8.js"><link rel="prefetch" href="/fe-tutorial/assets/js/81.975d0365.js"><link rel="prefetch" href="/fe-tutorial/assets/js/82.f96457f5.js"><link rel="prefetch" href="/fe-tutorial/assets/js/83.d5927169.js"><link rel="prefetch" href="/fe-tutorial/assets/js/84.d89f927d.js"><link rel="prefetch" href="/fe-tutorial/assets/js/85.1e0d52e2.js"><link rel="prefetch" href="/fe-tutorial/assets/js/9.2ddb0259.js">
    <link rel="stylesheet" href="/fe-tutorial/assets/css/0.styles.d95e4697.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/fe-tutorial/" class="home-link router-link-active"><!----> <span class="site-name">fe-tutorial</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/fe-tutorial/algo/" class="nav-link">数据结构和算法</a></div><div class="nav-item"><a href="/fe-tutorial/javaScript/" class="nav-link router-link-active">JavaScript</a></div><div class="nav-item"><a href="/fe-tutorial/webpack/" class="nav-link">Webpack</a></div><div class="nav-item"><a href="https://niexias.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  个人博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/niexias" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/fe-tutorial/algo/" class="nav-link">数据结构和算法</a></div><div class="nav-item"><a href="/fe-tutorial/javaScript/" class="nav-link router-link-active">JavaScript</a></div><div class="nav-item"><a href="/fe-tutorial/webpack/" class="nav-link">Webpack</a></div><div class="nav-item"><a href="https://niexias.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  个人博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/niexias" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JavaScript</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fe-tutorial/javaScript/" class="sidebar-link">介绍</a></li><li><a href="/fe-tutorial/javaScript/执行环境和执行栈.html" class="sidebar-link">执行环境和执行栈</a></li><li><a href="/fe-tutorial/javaScript/作用域和闭包.html" class="sidebar-link">作用域和闭包</a></li><li><a href="/fe-tutorial/javaScript/this.html" class="sidebar-link">this</a></li><li><a href="/fe-tutorial/javaScript/对象、原型和原型链.html" class="sidebar-link">对象、原型和原型链</a></li><li><a href="/fe-tutorial/javaScript/实现继承.html" class="sidebar-link">实现继承</a></li><li><a href="/fe-tutorial/javaScript/实现new.html" class="sidebar-link">实现 new</a></li><li><a href="/fe-tutorial/javaScript/实现call,apply和bind.html" class="sidebar-link">call、apply 和 bind</a></li><li><a href="/fe-tutorial/javaScript/实现instanceof.html" class="sidebar-link">实现 instanceof</a></li><li><a href="/fe-tutorial/javaScript/深拷贝和浅拷贝.html" class="sidebar-link">深拷贝和浅拷贝</a></li><li><a href="/fe-tutorial/javaScript/节流函数和防抖函数.html" class="sidebar-link">节流函数和防抖函数</a></li><li><a href="/fe-tutorial/javaScript/高阶函数.html" class="sidebar-link">高阶函数</a></li><li><a href="/fe-tutorial/javaScript/函数柯里化.html" class="sidebar-link">函数柯里化</a></li><li><a href="/fe-tutorial/javaScript/EventEmitter.html" class="sidebar-link">EventEmitter</a></li><li><a href="/fe-tutorial/javaScript/实现Promise.html" class="sidebar-link">/javaScript/实现Promise.html</a></li><li><a href="/fe-tutorial/javaScript/实现异步打印.html" class="sidebar-link">实现异步打印</a></li><li><a href="/fe-tutorial/javaScript/数组去重,扁平化和最值.html" class="sidebar-link">数组去重，扁平化和最值</a></li><li><a href="/fe-tutorial/javaScript/数组乱序.html" class="sidebar-link">数组乱序</a></li><li><a href="/fe-tutorial/javaScript/懒加载.html" class="sidebar-link">懒加载</a></li><li><a href="/fe-tutorial/javaScript/无限滚动.html" class="sidebar-link">无限滚动</a></li><li><a href="/fe-tutorial/javaScript/虚拟滚动.html" class="sidebar-link">/javaScript/虚拟滚动.html</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>RegExp</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fe-tutorial/javaScript/RegExp/正则表达式.html" class="sidebar-link">正则表达式</a></li><li><a href="/fe-tutorial/javaScript/RegExp/RegExp的属性和方法.html" class="sidebar-link">RegExp 的属性和方法</a></li><li><a href="/fe-tutorial/javaScript/RegExp/应用.html" class="sidebar-link">应用</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>浏览器工作原理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fe-tutorial/javaScript/browser/浏览器的多进程和JS单线程.html" class="sidebar-link">浏览器的多进程和JS单线程</a></li><li><a href="/fe-tutorial/javaScript/browser/浏览器渲染过程.html" class="sidebar-link">浏览器的渲染过程</a></li><li><a href="/fe-tutorial/javaScript/browser/EventLoop.html" class="active sidebar-link">Event Loop</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe-tutorial/javaScript/browser/EventLoop.html#浏览器的-eventloop" class="sidebar-link">浏览器的 EventLoop</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe-tutorial/javaScript/browser/EventLoop.html#任务队列" class="sidebar-link">任务队列</a></li><li class="sidebar-sub-header"><a href="/fe-tutorial/javaScript/browser/EventLoop.html#事件和回调函数" class="sidebar-link">事件和回调函数</a></li><li class="sidebar-sub-header"><a href="/fe-tutorial/javaScript/browser/EventLoop.html#event-loop-2" class="sidebar-link">Event Loop</a></li><li class="sidebar-sub-header"><a href="/fe-tutorial/javaScript/browser/EventLoop.html#宏任务与微任务" class="sidebar-link">宏任务与微任务</a></li><li class="sidebar-sub-header"><a href="/fe-tutorial/javaScript/browser/EventLoop.html#看一道题目" class="sidebar-link">看一道题目</a></li><li class="sidebar-sub-header"><a href="/fe-tutorial/javaScript/browser/EventLoop.html#结合前面的线程再看看" class="sidebar-link">结合前面的线程再看看</a></li></ul></li><li class="sidebar-sub-header"><a href="/fe-tutorial/javaScript/browser/EventLoop.html#node-环境的-eventloop" class="sidebar-link">Node 环境的 EventLoop</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe-tutorial/javaScript/browser/EventLoop.html#同步任务和异步任务" class="sidebar-link">同步任务和异步任务</a></li><li class="sidebar-sub-header"><a href="/fe-tutorial/javaScript/browser/EventLoop.html#本轮循环和次轮循环" class="sidebar-link">本轮循环和次轮循环</a></li><li class="sidebar-sub-header"><a href="/fe-tutorial/javaScript/browser/EventLoop.html#process-nexttick" class="sidebar-link">process.nextTick()</a></li><li class="sidebar-sub-header"><a href="/fe-tutorial/javaScript/browser/EventLoop.html#微任务" class="sidebar-link">微任务</a></li><li class="sidebar-sub-header"><a href="/fe-tutorial/javaScript/browser/EventLoop.html#事件循环的概念" class="sidebar-link">事件循环的概念</a></li><li class="sidebar-sub-header"><a href="/fe-tutorial/javaScript/browser/EventLoop.html#事件循环的六个阶段" class="sidebar-link">事件循环的六个阶段</a></li><li class="sidebar-sub-header"><a href="/fe-tutorial/javaScript/browser/EventLoop.html#settimeout-和-setimmediate" class="sidebar-link">setTimeout 和 setImmediate</a></li></ul></li><li class="sidebar-sub-header"><a href="/fe-tutorial/javaScript/browser/EventLoop.html#参考" class="sidebar-link">参考</a></li></ul></li><li><a href="/fe-tutorial/javaScript/browser/栈空间和堆空间.html" class="sidebar-link">栈空间和堆空间</a></li><li><a href="/fe-tutorial/javaScript/browser/垃圾回收.html" class="sidebar-link">垃圾回收</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>性能优化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fe-tutorial/javaScript/effective/性能优化.html" class="sidebar-link">性能优化</a></li><li><a href="/fe-tutorial/javaScript/effective/DNS缓存和预解析.html" class="sidebar-link">DNS 缓存和预解析</a></li><li><a href="/fe-tutorial/javaScript/effective/减少请求次数和体积.html" class="sidebar-link">减少请求次数和体积</a></li><li><a href="/fe-tutorial/javaScript/effective/利用缓存.html" class="sidebar-link">利用缓存</a></li><li><a href="/fe-tutorial/javaScript/effective/CDN.html" class="sidebar-link">CDN</a></li><li><a href="/fe-tutorial/javaScript/effective/浏览器渲染机制和优化.html" class="sidebar-link">浏览器渲染机制和优化</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="event-loop"><a href="#event-loop" class="header-anchor">#</a> Event Loop</h1> <p>JS 执行是单线程的，这也意味着，javascript代码在执行的任何时候，都只有一个主线程来处理所有的任务。而这种机制基于事件循环来实现的。</p> <h2 id="浏览器的-eventloop"><a href="#浏览器的-eventloop" class="header-anchor">#</a> 浏览器的 EventLoop</h2> <h3 id="任务队列"><a href="#任务队列" class="header-anchor">#</a> 任务队列</h3> <p>单线程就意味着，所有任务需要排队，前一个任务结束，才会执行后一个任务。如果前一个任务耗时很长，后一个任务就不得不一直等着。</p> <p>单线程就意味着，所有任务需要排队，前一个任务结束，才会执行后一个任务。如果前一个任务耗时很长，后一个任务就不得不一直等着。</p> <p>如果排队是因为计算量大，CPU 忙不过来，倒也算了，但是很多时候CPU是闲着的，因为 IO 设备（输入输出设备）很慢（比如 Ajax 操作从网络读取数据），不得不等着结果出来，再往下执行。</p> <p>JavaScrip t语言的设计者意识到，这时主线程完全可以不管IO设备，挂起处于等待中的任务，先运行排在后面的任务。等到IO设备返回了结果，再回过头，把挂起的任务继续执行下去。</p> <p>于是，所有任务可以分成两种，一种是同步任务（synchronous），另一种是异步任务（asynchronous）。同步任务指的是，在主线程上排队执行的任务，只有前一个任务执行完毕，才能执行后一个任务；异步任务指的是，不进入主线程、而进入&quot;任务队列&quot;（task queue）的任务，只有&quot;任务队列&quot;通知主线程，某个异步任务可以执行了，该任务才会进入主线程执行。</p> <p>具体来说，异步执行的运行机制如下。（同步执行也是如此，因为它可以被视为没有异步任务的异步执行。）</p> <ol><li>所有同步任务都在主线程上执行，形成一个执行栈（execution context stack）</li> <li>主线程之外，还存在一个&quot;任务队列&quot;（task queue）。只要异步任务有了运行结果，就在&quot;任务队列&quot;之中放置一个事件。</li> <li>一旦&quot;执行栈&quot;中的所有同步任务执行完毕，系统就会读取&quot;任务队列&quot;，看看里面有哪些事件。那些对应的异步任务，于是结束等待状态，进入执行栈，开始执行。</li> <li>主线程不断重复上面的第三步。</li></ol> <p>下图就是主线程和任务队列的示意图：</p> <p><img src="/fe-tutorial/assets/img/javascript-browser-EventLoop-taskQueue.b9e7e75d.jpg" alt="Task Queue"></p> <h3 id="事件和回调函数"><a href="#事件和回调函数" class="header-anchor">#</a> 事件和回调函数</h3> <p>&quot;任务队列&quot;是一个事件的队列（也可以理解成消息的队列），IO 设备完成一项任务，<strong>就在&quot;任务队列&quot;中添加一个事件，表示相关的异步任务可以进入&quot;执行栈&quot;了</strong>。主线程读取&quot;任务队列&quot;，就是读取里面有哪些事件。</p> <p>&quot;任务队列&quot;中的事件，除了 IO 设备的事件以外，还包括一些用户产生的事件（比如鼠标点击、页面滚动等等）。只要指定过回调函数，这些事件发生时就会进入&quot;任务队列&quot;，等待主线程读取。</p> <p>所谓&quot;回调函数&quot;（callback），就是那些会被主线程挂起来的代码。异步任务必须指定回调函数，当主线程开始执行异步任务，就是执行对应的回调函数。</p> <p>&quot;任务队列&quot;是一个先进先出的数据结构，排在前面的事件，优先被主线程读取。主线程的读取过程基本上是自动的，只要执行栈一清空，&quot;任务队列&quot;上第一位的事件就自动进入主线程。但是，由于存在&quot;定时器&quot;功能，可以放置定时事件，就是 <code>setTimeout</code> 和 <code>setInterval</code>，主线程首先要检查一下执行时间，只有到了规定的时间，才能返回主线程。</p> <h3 id="event-loop-2"><a href="#event-loop-2" class="header-anchor">#</a> Event Loop</h3> <p>主线程从&quot;任务队列&quot;中读取事件，这个过程是循环不断的，所以整个的这种运行机制又称为Event Loop（事件循环）。</p> <p>为了更好地理解Event Loop，请看下图（转引自Philip Roberts的演讲《Help, I'm stuck in an event-loop》）。</p> <p><img src="/fe-tutorial/assets/img/javascript-browser-EventLoop.80f6e345.jpg" alt="EventLoop"></p> <p>上图中，主线程运行的时候，产生堆（heap）和栈（stack），栈中的代码调用各种外部API，它们在&quot;任务队列&quot;中加入各种事件（click，load，done）。只要栈中的代码执行完毕，主线程就会去读取&quot;任务队列&quot;，依次执行那些事件所对应的回调函数。</p> <p>值得注意的是，任务队列的所有任务并不是怪怪排队的。</p> <h3 id="宏任务与微任务"><a href="#宏任务与微任务" class="header-anchor">#</a> 宏任务与微任务</h3> <p>异步任务也存在优先级，把异步任务分为两类：<strong>微任务</strong>（micro task）和<strong>宏任务</strong>（macro task）。常见的有：</p> <ul><li>Task(macroTask): setTimeout, setInterval, setImmediate, I/O, UI rendering。</li> <li>microTask: Promise, process.nextTick, Object.observe, MutationObserver。</li></ul> <p>针对这两种任务类型，任务队列实际上也对应有微任务队列和宏任务队列。当主线程执行栈为空时，主线程先查看微任务队列是否有事件存在：</p> <ol><li>如果有事件存在，<strong>会依次执行队列中事件对应的回调，直到微任务队列为空</strong>。然后去宏任务队列中取出最前面的一个事件，把对应的回调加入当前执行栈。</li> <li>如果事件不存在，则再去宏任务队列中取出一个事件并把对应的回到加入当前执行栈。</li></ol> <p>需要记住<strong>当前执行栈执行完毕时会立刻先处理所有微任务队列中的事件，然后再去宏任务队列中取出一个事件。同一次事件循环中，微任务永远在宏任务之前执行</strong>。</p> <h3 id="看一道题目"><a href="#看一道题目" class="header-anchor">#</a> 看一道题目</h3> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'script start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'script end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>输出的顺序是：</p> <div class="language-js extra-class"><pre class="language-js"><code>script start
script end
promise1
promise2
setTimeout
</code></pre></div><p>因为 <code>Promise</code> 是微任务，执行会优先于 <code>setTimeout</code>。</p> <h3 id="结合前面的线程再看看"><a href="#结合前面的线程再看看" class="header-anchor">#</a> 结合前面的线程再看看</h3> <p>在整个循环中，需要这些线程：</p> <ol><li>JS 引擎线程：主线程，执行任务。</li> <li>事件触发线程：事件触发线程管理着一个任务队列，只要异步任务有了运行结果，就在任务队列之中放置一个事件。</li> <li>定时触发器线程：定时计数器并不是由 JavaScript 引擎计数的，因为JavaScript引擎是单线程的, 如果处于阻塞线程状态就会影响记计时的准确。所以通过定时触发器线程来触发定时并计时，计时完毕后，添加到事件队列中，等待JS引擎空闲后执行。</li></ol> <h2 id="node-环境的-eventloop"><a href="#node-环境的-eventloop" class="header-anchor">#</a> Node 环境的 EventLoop</h2> <p>在 node 中，事件循环表现出的状态与浏览器中大致相同。不同的是node中有一套自己的模型。node 中事件循环的实现是依靠的 libuv 引擎。我们知道 node 选择 chrome v8 引擎作为 js 解释器，v8 引擎将 js 代码分析后去调用对应的node api，而这些api最后则由 libuv 引擎驱动，执行对应的任务，并把不同的事件放在不同的队列中等待主线程执行。 因此实际上 node 中的事件循环存在于 libuv 引擎中。</p> <p>为了协调异步任务，Node 居然提供了四个定时器，让任务可以在指定的时间运行。</p> <ul><li>setTimeout()</li> <li>setInterval()</li> <li>setImmediate()</li> <li>process.nextTick()</li></ul> <p>先看一段代码，它的运行结果是多少呢？</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// test.js</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>运行结果如下：</p> <div class="language-shell extra-class"><pre class="language-text"><code>node test.js
5
3
4
1
2
</code></pre></div><p>为什么是这样，接下来看看 Node 怎么处理各种定时器，或者更广义地说，libuv 库怎么安排异步任务在主线程上执行，它和浏览器的 EventLoop 有什么不同。</p> <h3 id="同步任务和异步任务"><a href="#同步任务和异步任务" class="header-anchor">#</a> 同步任务和异步任务</h3> <p>首先，同步任务总是比异步任务更早执行。所以前面那段代码，下面这行最先执行：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="本轮循环和次轮循环"><a href="#本轮循环和次轮循环" class="header-anchor">#</a> 本轮循环和次轮循环</h3> <p>异步任务可以分成<strong>两种</strong>：</p> <ul><li>追加在本轮循环的异步任务</li> <li>追加在次轮循环的异步任务</li></ul> <p>所谓&quot;循环&quot;，指的是事件循环（event loop）。</p> <p><strong>Node 规定，process.nextTick 和 Promise 的回调函数，追加在本轮循环，即同步任务一旦执行完成，就开始执行它们。而 setTimeout、setInterval、setImmediate 的回调函数，追加在次轮循环。</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 下面两行，次轮循环执行</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 下面两行，本轮循环执行</span>
process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="process-nexttick"><a href="#process-nexttick" class="header-anchor">#</a> process.nextTick()</h3> <p>process.nextTick 这个名字有点误导，它是在本轮循环执行的，而且是所有异步任务里面最快执行的。</p> <p>Node 执行完所有同步任务，接下来就会执行 process.nextTick 的任务队列。所以，下面这行代码是第二个输出结果。</p> <div class="language-js extra-class"><pre class="language-js"><code>process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>基本上，如果你希望异步任务尽可能快地执行，那就使用 process.nextTick。</p> <h3 id="微任务"><a href="#微任务" class="header-anchor">#</a> 微任务</h3> <p>根据语言规格，Promise 对象的回调函数，会进入异步任务里面的&quot;微任务&quot;（microtask）队列。</p> <p>微任务队列追加在 process.nextTick 队列的后面，也属于本轮循环。所以，下面的代码总是先输出3，再输出4。</p> <div class="language-js extra-class"><pre class="language-js"><code>process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 3</span>
<span class="token comment">// 4</span>
</code></pre></div><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQUAAACDCAMAAACz1v7SAAAAAXNSR0IB2cksfwAAAvdQTFRF////AAAA+/v7lZWV29vbc3NzpaWltra2y8vLLy8vuLi4QEBAS0tL/v7+AQEB/f39+Pj4/Pz8+vr69vb2DAwM9/f3AgICAwMDysrK8fHxQkJCw8PDBgYG9fX1o6Oj8vLyBwcH+fn5wMDAGRkZBQUFERER1tbWGhoaJycnCgoKEBAQBAQEExMT4+Pj9PT08/PzIyMj6OjozMzMGxsb7+/vDw8PDQ0NCwsLnJyc6urq0tLSCQkJsbGx7Ozs8PDw7u7u3NzcZmZmUlJSampq4ODgjo6OWFhYf39/TU1Nvr6+T09PSEhIJCQkz8/PXl5eFBQU0NDQj4+PFxcXJSUl7e3tEhIS6enpbGxsFRUVCAgIYWFhwsLCDg4OjY2N6+vrRERE39/f4uLisrKybm5uGBgY5+fndXV1MjIyZ2dneXl52dnZZWVl3t7eoqKiIiIira2tvb29pKSk2trazs7OPz8/2NjYdHR0xMTEMzMzgoKC09PTUVFRpqamubm5u7u7MDAwfHx8n5+fcnJympqah4eH0dHRg4ODqqqqKSkpJiYmMTExmZmZgYGBi4uLYmJiVFRUUFBQ19fX4eHhq6urWVlZhoaGioqKv7+/p6enenp6tLS0V1dXRkZGlJSUxsbG5eXlmJiYPDw8SUlJkZGRPT09oKCgKCgob29vFhYWkJCQHBwcTExM5ubm5OTkKysrt7e3l5eX1dXVk5OTaWlpsLCwa2trs7OzZGRkTk5OLS0tR0dHoaGhNzc33d3dx8fHISEhdnZ2bW1tXFxcU1NTQUFBxcXFNDQ0NTU1iYmJr6+vOTk5Ojo6ICAgLi4uY2NjX19fNjY2Hh4ezc3NcXFxyMjIe3t7vLy8rKysWlpaqampm5ubHR0dfn5+Pj4+1NTUXV1daGhoycnJcHBwLCwsW1tbwcHBjIyMKioqVVVVRUVFtbW1nZ2dQ0NDfX19d3d3Ozs7np6eSkpKrq6ukpKSiIiIYGBgurq6gICAqKioVlZWeHh4hISEODg4Nlsg4AAAAP10Uk5T/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////9tN244AABDHSURBVHic7ZxnXBNJH4DnH4oi7qaRjUgCiYSW0KvA0RQUVERAmhQVRRFQRAQBUQQEe++9995777333tvp9X4f3kmAM568yCK5iL99vkA288/OPpmdsjMThBiIBdrOAQMDAwMDAwMDAwMDAwMDw9cPYTzgWKPMWzML9RswhTNvZb4elGNG1FEC51H5+C5bejy+UlKi13ApKbnSY0uXLteucuskwVj/wZZ5Q/39BNy6avwiILgCP//rG7dMXGJWh2j7MRM3BvLqPVNagrV22dKf+bTDiDLDPXWR98XC2T+wmHah9m2aL9ZEZrQHq+UPPnRj4jvkaCIr2sTuj810QxKXNug6sTrsT06gW7wnjNNITrSJ1HRNd5ohRSEayYk24W7fPYlmyJ00jeREm7CHdu1EM8R2bX2cmGP3nmipq90Czgdv8+3sXNWqH25SgUmL7HUcpBmIGd9ephni1vnzTslLWuDERZZt3nMt483UdEv1Opft3KbNsvcdW/HMgN1785o/XUX37q0t8c0b04ww8v28M2b0WTw+GrUg33Px8jYqtsUHFr4hyRWsqlfd/4pUAIbquaOTZtqn+ObNaEYYGX/eGTt1hX6BqJm1tXU/I4CIUdbWEwYUPtQb8KEFgB5VFqS3zUmFY/DNFzbg0VozpcFESxYEGRkZM14B5OtmZCzgif1cWepp1C0Qx06QcL4sJWmfjhFYNfq8k/8f6tnC1OD0nLtnrJeGuyLl3R1w4sBoPR/EvToh+JdmBLdt8ISgPYaxYNM1OBu/r9sOQEd5ra4bdz4tIBCx74phhycvk/lVFiaN3znhuniVBNqrao3oFUDe7M7+JbhjKK4/pwUH44LBDj10+sCuGE/c9ckKDg7ByfoGT/geJ7Y8tOjSk9bZtbuD6tmCBUTdVIiEQI7jIUFLC1LkLQTDdSgpV0Hlem7wgFEmb+MoIOO8h6pb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" alt="microtask"></p> <p><strong>注意，只有前一个队列全部清空以后，才会执行下一个队列。</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 1</span>
<span class="token comment">// 3</span>
<span class="token comment">// 2</span>
<span class="token comment">// 4</span>
</code></pre></div><p>上面代码中，全部 process.nextTick 的回调函数，执行都会早于 Promise 的。</p> <p>至此，循环的执行顺序就是：</p> <ol><li>同步任务</li> <li>process.nextTick()</li> <li>微任务</li></ol> <h3 id="事件循环的概念"><a href="#事件循环的概念" class="header-anchor">#</a> 事件循环的概念</h3> <p>为了理解次轮循环的执行顺序，这就必须理解什么是事件循环（event loop）了。</p> <p>Node 的官方文档是这样介绍的：</p> <blockquote><p>&quot;When Node.js starts, it initializes the event loop, processes the provided input script which may make async API calls, schedule timers, or call process.nextTick(), then begins processing the event loop.&quot;</p></blockquote> <p>它表达了三层意思。</p> <p>首先，有些人以为，除了主线程，还存在一个单独的事件循环线程。不是这样的，只有一个主线程，事件循环是在主线程上完成的。</p> <p>其次，Node 开始执行脚本时，会先进行事件循环的初始化，但是这时事件循环还没有开始，会先完成下面的事情：</p> <ul><li>同步任务</li> <li>发出异步请求</li> <li>规划定时器生效的时间</li> <li>执行process.nextTick()等等</li></ul> <h3 id="事件循环的六个阶段"><a href="#事件循环的六个阶段" class="header-anchor">#</a> 事件循环的六个阶段</h3> <p>事件循环会无限次地执行，一轮又一轮。只有异步任务的回调函数队列清空了，才会停止执行。</p> <p>每一轮的事件循环，<strong>分成六个阶段</strong>。这些阶段会依次执行：</p> <ol><li>timers</li> <li>I/O callbacks</li> <li>idle, prepare</li> <li>poll</li> <li>check</li> <li>close callbacks</li></ol> <p><strong>每个阶段都有一个先进先出的回调函数队列。只有一个阶段的回调函数队列清空了，该执行的回调函数都执行了，事件循环才会进入下一个阶段。</strong></p> <p><img src="/fe-tutorial/assets/img/javascript-browser-EventLoop-node-eg2.494a2384.png" alt="EventLoop"></p> <p>下面简单介绍一下每个阶段的含义：</p> <p><strong>1. timers</strong></p> <p>这个是定时器阶段，处理 <code>setTimeout()</code> 和 <code>setInterval()</code> 的回调函数。进入这个阶段后，主线程会检查一下当前时间，是否满足定时器的条件。如果满足就执行回调函数，否则就离开这个阶段。</p> <p><strong>2. I/O callbacks</strong></p> <p>除了以下操作的回调函数，其他的回调函数都在这个阶段执行。</p> <ul><li><code>setTimeout()</code> 和 <code>setInterval()</code> 的回调函数；</li> <li><code>setImmediate()</code> 的回调函数；</li> <li>用于关闭请求的回调函数，比如 <code>socket.on('close', ...)</code>。</li></ul> <p><strong>3. idle, prepare</strong></p> <p>该阶段只供 libuv 内部调用，这里可以忽略。</p> <p><strong>4. Poll</strong></p> <p>这个阶段是轮询时间，用于等待还未返回的 I/O 事件，比如服务器的回应、用户移动鼠标等等。</p> <p>这个阶段的时间会比较长。如果没有其他异步任务要处理（比如到期的定时器），会一直停留在这个阶段，等待 I/O 请求返回结果。</p> <p><strong>5. check</strong></p> <p>该阶段执行 <code>setImmediate()</code> 的回调函数。</p> <p><strong>6. close callbacks</strong></p> <p>该阶段执行关闭请求的回调函数，比如 <code>socket.on('close', ...)</code>。</p> <h3 id="settimeout-和-setimmediate"><a href="#settimeout-和-setimmediate" class="header-anchor">#</a> setTimeout 和 setImmediate</h3> <p>由于 <code>setTimeout</code> 在 timers 阶段执行，而 <code>setImmediate</code> 在 check 阶段执行。所以，<code>setTimeout</code> 会早于 <code>setImmediate</code> 完成。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上面代码应该先输出 1，再输出 2，但是实际执行的时候，结果却是不确定，有时还会先输出 2，再输出 1。</p> <p>这是因为 <code>setTimeout</code> 的第二个参数默认为 0。但是实际上，Node 做不到0毫秒，最少也需要 1 毫秒，根据官方文档，第二个参数的取值范围在 1 毫秒到 2147483647 毫秒之间。也就是说，<code>setTimeout(f, 0)</code> 等同于 <code>setTimeout(f, 1)</code>。</p> <p>**实际执行的时候，进入事件循环以后，有可能到了 1 毫秒，也可能还没到 1 毫秒，取决于系统当时的状况。**如果没到 1 毫秒，那么 timers 阶段就会跳过，进入 check 阶段，先执行 <code>setImmediate</code> 的回调函数。</p> <p>但是，下面的代码一定是先输出 2，再输出 1：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'test.js'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上面代码会先进入 I/O callbacks 阶段，然后是 check 阶段，最后才是 timers <code>阶段。因此，setImmediate</code> 才会早于 <code>setTimeout</code> 执行。</p> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <ul><li><a href="http://www.ruanyifeng.com/blog/2014/10/event-loop.html" target="_blank" rel="noopener noreferrer">JavaScript 运行机制详解：再谈Event Loop<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://zhuanlan.zhihu.com/p/33058983" target="_blank" rel="noopener noreferrer">详解JavaScript中的Event Loop（事件循环）机制<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://juejin.im/post/5aab2d896fb9a028b86dc2fd" target="_blank" rel="noopener noreferrer">JavaScript 运行机制--Event Loop详解<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://www.ruanyifeng.com/blog/2018/02/node-event-loop.html" target="_blank" rel="noopener noreferrer">Node 定时器详解<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">11/27/2019, 4:25:00 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/fe-tutorial/javaScript/browser/浏览器渲染过程.html" class="prev">浏览器的渲染过程</a></span> <span class="next"><a href="/fe-tutorial/javaScript/browser/栈空间和堆空间.html">栈空间和堆空间</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/fe-tutorial/assets/js/app.543b8577.js" defer></script><script src="/fe-tutorial/assets/js/2.9b3345fe.js" defer></script><script src="/fe-tutorial/assets/js/17.36973dd6.js" defer></script>
  </body>
</html>
