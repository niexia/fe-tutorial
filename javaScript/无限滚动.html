<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>无限滚动 | fe-tutorial</title>
    <meta name="description" content="前端学习笔记">
    <link rel="icon" href="/fe-tutorial/favicon.ico">
    
    <link rel="preload" href="/fe-tutorial/assets/css/0.styles.d95e4697.css" as="style"><link rel="preload" href="/fe-tutorial/assets/js/app.92d09d44.js" as="script"><link rel="preload" href="/fe-tutorial/assets/js/2.069bf11e.js" as="script"><link rel="preload" href="/fe-tutorial/assets/js/19.d62badee.js" as="script"><link rel="prefetch" href="/fe-tutorial/assets/js/10.0f0e04ed.js"><link rel="prefetch" href="/fe-tutorial/assets/js/11.cce73e64.js"><link rel="prefetch" href="/fe-tutorial/assets/js/12.512c73ea.js"><link rel="prefetch" href="/fe-tutorial/assets/js/13.0de16b17.js"><link rel="prefetch" href="/fe-tutorial/assets/js/14.ca905437.js"><link rel="prefetch" href="/fe-tutorial/assets/js/15.882b829f.js"><link rel="prefetch" href="/fe-tutorial/assets/js/16.3e3fda30.js"><link rel="prefetch" href="/fe-tutorial/assets/js/17.71aa6dcc.js"><link rel="prefetch" href="/fe-tutorial/assets/js/18.d4b77cb1.js"><link rel="prefetch" href="/fe-tutorial/assets/js/20.4c51ea42.js"><link rel="prefetch" href="/fe-tutorial/assets/js/21.e16fd625.js"><link rel="prefetch" href="/fe-tutorial/assets/js/22.d0a18daf.js"><link rel="prefetch" href="/fe-tutorial/assets/js/23.4479daf6.js"><link rel="prefetch" href="/fe-tutorial/assets/js/24.c2faf7b7.js"><link rel="prefetch" href="/fe-tutorial/assets/js/25.9022d79e.js"><link rel="prefetch" href="/fe-tutorial/assets/js/26.82cae8ac.js"><link rel="prefetch" href="/fe-tutorial/assets/js/27.a9d47846.js"><link rel="prefetch" href="/fe-tutorial/assets/js/28.4ee366f6.js"><link rel="prefetch" href="/fe-tutorial/assets/js/29.5d8b318d.js"><link rel="prefetch" href="/fe-tutorial/assets/js/3.e9d79976.js"><link rel="prefetch" href="/fe-tutorial/assets/js/30.47e699df.js"><link rel="prefetch" href="/fe-tutorial/assets/js/31.459c98c8.js"><link rel="prefetch" href="/fe-tutorial/assets/js/32.b26a0591.js"><link rel="prefetch" href="/fe-tutorial/assets/js/33.a354034d.js"><link rel="prefetch" href="/fe-tutorial/assets/js/34.dc3d1894.js"><link rel="prefetch" href="/fe-tutorial/assets/js/35.7124816b.js"><link rel="prefetch" href="/fe-tutorial/assets/js/36.5e448123.js"><link rel="prefetch" href="/fe-tutorial/assets/js/37.c5980646.js"><link rel="prefetch" href="/fe-tutorial/assets/js/38.9ae67a2a.js"><link rel="prefetch" href="/fe-tutorial/assets/js/39.4d80d2ea.js"><link rel="prefetch" href="/fe-tutorial/assets/js/4.bf78fe01.js"><link rel="prefetch" href="/fe-tutorial/assets/js/40.3ab5d0e2.js"><link rel="prefetch" href="/fe-tutorial/assets/js/41.be291b2e.js"><link rel="prefetch" href="/fe-tutorial/assets/js/42.2aac3365.js"><link rel="prefetch" href="/fe-tutorial/assets/js/43.151f8860.js"><link rel="prefetch" href="/fe-tutorial/assets/js/44.a9cb7472.js"><link rel="prefetch" href="/fe-tutorial/assets/js/45.87fbdf8f.js"><link rel="prefetch" href="/fe-tutorial/assets/js/46.a1b9bec0.js"><link rel="prefetch" href="/fe-tutorial/assets/js/47.10f63b29.js"><link rel="prefetch" href="/fe-tutorial/assets/js/48.3ad27822.js"><link rel="prefetch" href="/fe-tutorial/assets/js/49.f57055fc.js"><link rel="prefetch" href="/fe-tutorial/assets/js/5.5f3b47a9.js"><link rel="prefetch" href="/fe-tutorial/assets/js/50.b7c47e95.js"><link rel="prefetch" href="/fe-tutorial/assets/js/51.04059def.js"><link rel="prefetch" href="/fe-tutorial/assets/js/52.587b865f.js"><link rel="prefetch" href="/fe-tutorial/assets/js/53.15eda5ee.js"><link rel="prefetch" href="/fe-tutorial/assets/js/54.0d5ec066.js"><link rel="prefetch" href="/fe-tutorial/assets/js/55.1f994649.js"><link rel="prefetch" href="/fe-tutorial/assets/js/56.fd9cad59.js"><link rel="prefetch" href="/fe-tutorial/assets/js/57.9b12c3ce.js"><link rel="prefetch" href="/fe-tutorial/assets/js/58.092931cf.js"><link rel="prefetch" href="/fe-tutorial/assets/js/59.bc7c343d.js"><link rel="prefetch" href="/fe-tutorial/assets/js/6.ed1e0122.js"><link rel="prefetch" href="/fe-tutorial/assets/js/60.e0e575df.js"><link rel="prefetch" href="/fe-tutorial/assets/js/61.233ddac5.js"><link rel="prefetch" href="/fe-tutorial/assets/js/62.d0c7e731.js"><link rel="prefetch" href="/fe-tutorial/assets/js/63.5021dfc7.js"><link rel="prefetch" href="/fe-tutorial/assets/js/64.962e6326.js"><link rel="prefetch" href="/fe-tutorial/assets/js/65.41f2ba69.js"><link rel="prefetch" href="/fe-tutorial/assets/js/66.733fd24f.js"><link rel="prefetch" href="/fe-tutorial/assets/js/67.1a193d72.js"><link rel="prefetch" href="/fe-tutorial/assets/js/68.e7d7d22b.js"><link rel="prefetch" href="/fe-tutorial/assets/js/69.2a57202b.js"><link rel="prefetch" href="/fe-tutorial/assets/js/7.34683cc7.js"><link rel="prefetch" href="/fe-tutorial/assets/js/70.c7bd353a.js"><link rel="prefetch" href="/fe-tutorial/assets/js/71.3b88c320.js"><link rel="prefetch" href="/fe-tutorial/assets/js/72.9dd3c2e6.js"><link rel="prefetch" href="/fe-tutorial/assets/js/73.c0cf2ae4.js"><link rel="prefetch" href="/fe-tutorial/assets/js/74.4fc5d602.js"><link rel="prefetch" href="/fe-tutorial/assets/js/75.e2a5cc3b.js"><link rel="prefetch" href="/fe-tutorial/assets/js/76.53bab021.js"><link rel="prefetch" href="/fe-tutorial/assets/js/77.b43b5ed2.js"><link rel="prefetch" href="/fe-tutorial/assets/js/78.0975b09f.js"><link rel="prefetch" href="/fe-tutorial/assets/js/79.884b0353.js"><link rel="prefetch" href="/fe-tutorial/assets/js/8.89500b54.js"><link rel="prefetch" href="/fe-tutorial/assets/js/80.12ce9258.js"><link rel="prefetch" href="/fe-tutorial/assets/js/81.29200940.js"><link rel="prefetch" href="/fe-tutorial/assets/js/82.b6e5dff8.js"><link rel="prefetch" href="/fe-tutorial/assets/js/83.0f67c205.js"><link rel="prefetch" href="/fe-tutorial/assets/js/84.592be33b.js"><link rel="prefetch" href="/fe-tutorial/assets/js/85.f94e519a.js"><link rel="prefetch" href="/fe-tutorial/assets/js/86.6af52bed.js"><link rel="prefetch" href="/fe-tutorial/assets/js/9.61511d3e.js">
    <link rel="stylesheet" href="/fe-tutorial/assets/css/0.styles.d95e4697.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/fe-tutorial/" class="home-link router-link-active"><!----> <span class="site-name">fe-tutorial</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/fe-tutorial/algo/" class="nav-link">数据结构和算法</a></div><div class="nav-item"><a href="/fe-tutorial/javaScript/" class="nav-link router-link-active">JavaScript</a></div><div class="nav-item"><a href="/fe-tutorial/webpack/" class="nav-link">Webpack</a></div><div class="nav-item"><a href="https://niexias.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  个人博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/niexias" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/fe-tutorial/algo/" class="nav-link">数据结构和算法</a></div><div class="nav-item"><a href="/fe-tutorial/javaScript/" class="nav-link router-link-active">JavaScript</a></div><div class="nav-item"><a href="/fe-tutorial/webpack/" class="nav-link">Webpack</a></div><div class="nav-item"><a href="https://niexias.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  个人博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/niexias" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>JavaScript</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fe-tutorial/javaScript/" class="sidebar-link">介绍</a></li><li><a href="/fe-tutorial/javaScript/执行环境和执行栈.html" class="sidebar-link">执行环境和执行栈</a></li><li><a href="/fe-tutorial/javaScript/作用域和闭包.html" class="sidebar-link">作用域和闭包</a></li><li><a href="/fe-tutorial/javaScript/this.html" class="sidebar-link">this</a></li><li><a href="/fe-tutorial/javaScript/对象、原型和原型链.html" class="sidebar-link">对象、原型和原型链</a></li><li><a href="/fe-tutorial/javaScript/实现继承.html" class="sidebar-link">实现继承</a></li><li><a href="/fe-tutorial/javaScript/实现new.html" class="sidebar-link">实现 new</a></li><li><a href="/fe-tutorial/javaScript/实现call,apply和bind.html" class="sidebar-link">call、apply 和 bind</a></li><li><a href="/fe-tutorial/javaScript/实现instanceof.html" class="sidebar-link">实现 instanceof</a></li><li><a href="/fe-tutorial/javaScript/深拷贝和浅拷贝.html" class="sidebar-link">深拷贝和浅拷贝</a></li><li><a href="/fe-tutorial/javaScript/节流函数和防抖函数.html" class="sidebar-link">节流函数和防抖函数</a></li><li><a href="/fe-tutorial/javaScript/高阶函数.html" class="sidebar-link">高阶函数</a></li><li><a href="/fe-tutorial/javaScript/函数柯里化.html" class="sidebar-link">函数柯里化</a></li><li><a href="/fe-tutorial/javaScript/EventEmitter.html" class="sidebar-link">EventEmitter</a></li><li><a href="/fe-tutorial/javaScript/实现Promise.html" class="sidebar-link">/javaScript/实现Promise.html</a></li><li><a href="/fe-tutorial/javaScript/实现异步打印.html" class="sidebar-link">实现异步打印</a></li><li><a href="/fe-tutorial/javaScript/数组去重,扁平化和最值.html" class="sidebar-link">数组去重，扁平化和最值</a></li><li><a href="/fe-tutorial/javaScript/数组乱序.html" class="sidebar-link">数组乱序</a></li><li><a href="/fe-tutorial/javaScript/懒加载.html" class="sidebar-link">懒加载</a></li><li><a href="/fe-tutorial/javaScript/无限滚动.html" class="active sidebar-link">无限滚动</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fe-tutorial/javaScript/无限滚动.html#实现原理" class="sidebar-link">实现原理</a></li><li class="sidebar-sub-header"><a href="/fe-tutorial/javaScript/无限滚动.html#element-的-infinitescroll-无限滚动" class="sidebar-link">element 的 InfiniteScroll 无限滚动</a></li><li class="sidebar-sub-header"><a href="/fe-tutorial/javaScript/无限滚动.html#参考" class="sidebar-link">参考</a></li></ul></li><li><a href="/fe-tutorial/javaScript/虚拟滚动.html" class="sidebar-link">/javaScript/虚拟滚动.html</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>RegExp</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fe-tutorial/javaScript/RegExp/正则表达式.html" class="sidebar-link">正则表达式</a></li><li><a href="/fe-tutorial/javaScript/RegExp/RegExp的属性和方法.html" class="sidebar-link">RegExp 的属性和方法</a></li><li><a href="/fe-tutorial/javaScript/RegExp/应用.html" class="sidebar-link">应用</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>浏览器工作原理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fe-tutorial/javaScript/browser/浏览器的多进程和JS单线程.html" class="sidebar-link">浏览器的多进程和JS单线程</a></li><li><a href="/fe-tutorial/javaScript/browser/浏览器渲染过程.html" class="sidebar-link">浏览器的渲染过程</a></li><li><a href="/fe-tutorial/javaScript/browser/EventLoop.html" class="sidebar-link">Event Loop</a></li><li><a href="/fe-tutorial/javaScript/browser/栈空间和堆空间.html" class="sidebar-link">栈空间和堆空间</a></li><li><a href="/fe-tutorial/javaScript/browser/垃圾回收.html" class="sidebar-link">垃圾回收</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>性能优化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fe-tutorial/javaScript/effective/性能优化.html" class="sidebar-link">性能优化</a></li><li><a href="/fe-tutorial/javaScript/effective/DNS缓存和预解析.html" class="sidebar-link">DNS 缓存和预解析</a></li><li><a href="/fe-tutorial/javaScript/effective/减少请求次数和体积.html" class="sidebar-link">减少请求次数和体积</a></li><li><a href="/fe-tutorial/javaScript/effective/利用缓存.html" class="sidebar-link">利用缓存</a></li><li><a href="/fe-tutorial/javaScript/effective/CDN.html" class="sidebar-link">CDN</a></li><li><a href="/fe-tutorial/javaScript/effective/浏览器渲染机制和优化.html" class="sidebar-link">浏览器渲染机制和优化</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="无限滚动"><a href="#无限滚动" class="header-anchor">#</a> 无限滚动</h1> <p>InfiniteScroll 无限滚动，也就是滚动到底部时，加载更多的数据。</p> <h2 id="实现原理"><a href="#实现原理" class="header-anchor">#</a> 实现原理</h2> <p>无限滚动的原理就是，用户滚动，当滚动条到底的时候就加载。所以很关键的一点是要知道滚动条和底部的距离。</p> <p>先了解三个概念：</p> <ul><li>scrollHeight：只读属性，是一个元素内容高度的度量，包括由于溢出导致的视图中不可见内容。</li> <li>scrollTop：可以获取或设置一个元素的内容垂直滚动的像素数。</li> <li>clientHeight：只读属性，对于没有定义CSS或者内联布局盒子的元素为0，否则，它是元素内部的高度(单位像素)，包含内边距，但不包括水平滚动条、边框和外边距。</li></ul> <p><img src="/fe-tutorial/assets/img/javascript-InfiniteScroll-eg1.09797c45.png" alt="eg1"></p> <p>通过计算就可以的得到滚动条到底部的距离：</p> <div class="language- extra-class"><pre class="language-text"><code>distance = Element.scrollHeight - Element.scrollTop - Element.clientHeight
</code></pre></div><h2 id="element-的-infinitescroll-无限滚动"><a href="#element-的-infinitescroll-无限滚动" class="header-anchor">#</a> element 的 InfiniteScroll 无限滚动</h2> <p>可以试一下如何使用 <a href="https://element.eleme.cn/#/zh-CN/component/infiniteScroll" target="_blank" rel="noopener noreferrer">InfiniteScroll<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，然后 element 的<a href="https://github.com/ElemeFE/element/blob/dev/packages/infinite-scroll/src/main.js" target="_blank" rel="noopener noreferrer">源码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>是怎么实现的：</p> <div class="language- extra-class"><pre class="language-text"><code>export default {
  name: 'InfiniteScroll',
  inserted(el, binding, vnode) {
    const cb = binding.value;

    const vm = vnode.context;
    // only include vertical scroll
    const container = getScrollContainer(el, true);
    const { delay, immediate } = getScrollOptions(el, vm);
    const onScroll = throttle(delay, handleScroll.bind(el, cb));

    el[scope] = { el, vm, container, onScroll };

    if (container) {
      container.addEventListener('scroll', onScroll);

      if (immediate) {
        const observer = el[scope].observer = new MutationObserver(onScroll);
        observer.observe(container, { childList: true, subtree: true });
        onScroll();
      }
    }
  },
  unbind(el) {
    const { container, onScroll } = el[scope];
    if (container) {
      container.removeEventListener('scroll', onScroll);
    }
  }
};
</code></pre></div><p>通过指令的方式来实现的，<code>inserted</code> 钩子在被绑定元素插入父节点时调用，首先通过 <code>const container = getScrollContainer(el, true);</code> 获取滚动的元素，这个方法定义在 <code>element-ui/src/utils/dom</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">isScroll</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> vertical</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isServer<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> determinedDirection <span class="token operator">=</span> vertical <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">||</span> vertical <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> overflow <span class="token operator">=</span> determinedDirection
    <span class="token operator">?</span> vertical
      <span class="token operator">?</span> <span class="token function">getStyle</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token string">'overflow-y'</span><span class="token punctuation">)</span>
      <span class="token punctuation">:</span> <span class="token function">getStyle</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token string">'overflow-x'</span><span class="token punctuation">)</span>
    <span class="token punctuation">:</span> <span class="token function">getStyle</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token string">'overflow'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> overflow<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/(scroll|auto)/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getScrollContainer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> vertical</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isServer<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> parent <span class="token operator">=</span> el<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>window<span class="token punctuation">,</span> document<span class="token punctuation">,</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> window<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isScroll</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> vertical<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> parent<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    parent <span class="token operator">=</span> parent<span class="token punctuation">.</span>parentNode<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> parent<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>从该元素开始循环判断父元素是否定义了 <code>overflow</code> 样式，来确定滚动容器 <code>container</code>。</p> <p>接下来就会监听滚动容器的滚动事件。滚动的时候就执行 <code>onScroll</code> 方法，为了优化性能，这个方法是节流函数 <code>throttle</code> 执行之后返回的，所以实际上执行的是 <code>handleScroll</code>。这个等会再分析。</p> <p>先看下面的代码对 <code>immediate</code> 的判断，如果是 <code>true</code>，即立即执行，则创建一个 <code>new MutationObserver(onScroll)</code> 实例，并监听容器，内容改变之后会执行回调函数 <code>onScroll</code>。</p> <p>为什么这么处理呢？</p> <p>因为无限滚动是通过滚动加载实现的，如果初始状态下内容无法撑满容器，就无法出现滚动条，那就会造成后面无法滚动加载数据了！这个默认就是 <code>true</code>，保证加载到出现滚动条。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> onScroll <span class="token operator">=</span> <span class="token function">throttle</span><span class="token punctuation">(</span>delay<span class="token punctuation">,</span> <span class="token function">handleScroll</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> cb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>container<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  container<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">,</span> onScroll<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>immediate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> observer <span class="token operator">=</span> el<span class="token punctuation">[</span>scope<span class="token punctuation">]</span><span class="token punctuation">.</span>observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutationObserver</span><span class="token punctuation">(</span>onScroll<span class="token punctuation">)</span><span class="token punctuation">;</span>
    observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> <span class="token punctuation">{</span> childList<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> subtree<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">onScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>handleScroll</code> 的实现如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">handleScroll</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> el<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> container<span class="token punctuation">,</span> observer <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span>scope<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> distance<span class="token punctuation">,</span> disabled <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">getScrollOptions</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> vm<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>disabled<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> containerInfo <span class="token operator">=</span> container<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>containerInfo<span class="token punctuation">.</span>width <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>containerInfo<span class="token punctuation">.</span>height<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> shouldTrigger <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>container <span class="token operator">===</span> el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// be aware of difference between clientHeight &amp; offsetHeight &amp; window.getComputedStyle().height</span>
    <span class="token keyword">const</span> scrollBottom <span class="token operator">=</span> container<span class="token punctuation">.</span>scrollTop <span class="token operator">+</span> <span class="token function">getClientHeight</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
    shouldTrigger <span class="token operator">=</span> container<span class="token punctuation">.</span>scrollHeight <span class="token operator">-</span> scrollBottom <span class="token operator">&lt;=</span> distance<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> heightBelowTop <span class="token operator">=</span> <span class="token function">getOffsetHeight</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">getElementTop</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">getElementTop</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> offsetHeight <span class="token operator">=</span> <span class="token function">getOffsetHeight</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> borderBottom <span class="token operator">=</span> Number<span class="token punctuation">.</span><span class="token function">parseFloat</span><span class="token punctuation">(</span><span class="token function">getStyleComputedProperty</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> <span class="token string">'borderBottomWidth'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    shouldTrigger <span class="token operator">=</span> heightBelowTop <span class="token operator">-</span> offsetHeight <span class="token operator">+</span> borderBottom <span class="token operator">&lt;=</span> distance<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldTrigger <span class="token operator">&amp;&amp;</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">cb</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>observer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    observer<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">[</span>scope<span class="token punctuation">]</span><span class="token punctuation">.</span>observer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>看一下主要流程，首先会判断 <code>disabled</code>，如果是 <code>true</code> 直接返回。可以结合官方实例，实际开发中，如果正在加载数据，那么就可以将 <code>disabled</code> 设置为 <code>true</code>，避免多次触发。</p> <p>根据容器不同，判断方法有些差异：</p> <ol><li>如果滚动容器是绑定的元素本身，那就通过前面说明的那种方式：</li></ol> <div class="language-js extra-class"><pre class="language-js"><code>Element<span class="token punctuation">.</span>scrollHeight <span class="token operator">-</span> Element<span class="token punctuation">.</span>scrollTop <span class="token operator">-</span> Element<span class="token punctuation">.</span>clientHeight <span class="token operator">===</span> <span class="token number">0</span>
</code></pre></div><p>判断是否已经到底部了。这里是判断是否小于等于 <code>distance</code>，它提供了一个配置项，距离底部 <code>distance</code> 的时候就可以触发回调了。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> scrollBottom <span class="token operator">=</span> container<span class="token punctuation">.</span>scrollTop <span class="token operator">+</span> <span class="token function">getClientHeight</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
shouldTrigger <span class="token operator">=</span> container<span class="token punctuation">.</span>scrollHeight <span class="token operator">-</span> scrollBottom <span class="token operator">&lt;=</span> distance<span class="token punctuation">;</span>
</code></pre></div><ol start="2"><li>如果滚动容器不是元素本身，那判断就会麻烦一些：</li></ol> <p><img src="/fe-tutorial/assets/img/javascript-InfiniteScroll-eg2.92359232.png" alt="eg2"></p> <p>当鼠标往下滚的时候，<code>el</code> 就会向上，<code>heightBelowTop - offsetHeight + borderBottom</code> 其实就是 <code>el</code> 底部到 <code>container</code> 的距离，它和 <code>distance</code> 含义其实是一样的。</p> <p><img src="/fe-tutorial/assets/img/javascript-InfiniteScroll-eg3.ef0569f1.png" alt="eg3">。</p> <p>如果满足条件就会执行回调 <code>cb.call(vm)</code>。同时，上面说过设置 <code>immediate</code> 会立即加载，加载完成之后移除 <code>observer</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>shouldTrigger <span class="token operator">&amp;&amp;</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">cb</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>observer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  observer<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">[</span>scope<span class="token punctuation">]</span><span class="token punctuation">.</span>observer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Element/scrollHeight" target="_blank" rel="noopener noreferrer">Element.scrollHeight<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Element/scrollTop" target="_blank" rel="noopener noreferrer">Element.scrollTop<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Element/clientHeight" target="_blank" rel="noopener noreferrer">Element.clientHeight<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://element.eleme.cn/#/zh-CN/component/infiniteScroll" target="_blank" rel="noopener noreferrer">InfiniteScroll 无限滚动组件<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/MutationObserver" target="_blank" rel="noopener noreferrer">MDN-MutationObserver<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">11/17/2019, 12:55:27 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/fe-tutorial/javaScript/懒加载.html" class="prev">懒加载</a></span> <span class="next"><a href="/fe-tutorial/javaScript/虚拟滚动.html">/javaScript/虚拟滚动.html</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/fe-tutorial/assets/js/app.92d09d44.js" defer></script><script src="/fe-tutorial/assets/js/2.069bf11e.js" defer></script><script src="/fe-tutorial/assets/js/19.d62badee.js" defer></script>
  </body>
</html>
